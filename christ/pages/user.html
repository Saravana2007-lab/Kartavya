<!DOCTYPE html>
<html>
<head>
  <title>User Registration</title>
</head>
<body>

<h2 id="title">User Registration</h2>

<div id="loginBox">
  <input id="name" placeholder="Full Name"><br><br>
  <input id="aadhaar" placeholder="Aadhaar Number"><br><br>
  <input id="phone" placeholder="Phone Number"><br><br>

  <div id="recaptcha"></div><br>

  <button onclick="sendOTP()">Send OTP</button><br><br>

  <input id="otp" placeholder="Enter OTP"><br><br>
  <button onclick="verifyOTP()">Verify OTP</button>
</div>

<hr>

<div id="dashboard" style="display:none;">
  <h3>Welcome! You are logged in ✅</h3>
</div>

<script type="module">
import { auth, db } from "../firebase.js";
import {
  RecaptchaVerifier,
  signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

let confirmationResult;

// Setup reCAPTCHA
const recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha", {
  size: "normal"
});

// Send OTP
window.sendOTP = async function () {
  const phoneInput = document.getElementById("phone").value.trim();

  if (!phoneInput) {
    alert("Enter phone number");
    return;
  }

  const phone = "+91" + phoneInput;

  try {
    confirmationResult = await signInWithPhoneNumber(
      auth,
      phone,
      recaptchaVerifier
    );
    alert("OTP Sent!");
  } catch (err) {
    alert(err.message);
  }
};

// Verify OTP
window.verifyOTP = async function () {
  const otp = document.getElementById("otp").value.trim();

  if (!otp) {
    alert("Enter OTP");
    return;
  }

  try {
    const result = await confirmationResult.confirm(otp);

    await setDoc(doc(db, "users", result.user.uid), {
      name: document.getElementById("name").value,
      aadhaar: document.getElementById("aadhaar").value,
      phone: document.getElementById("phone").value,
      createdAt: new Date()
    });

    alert("Login Successful ✅");

    // Hide login, show dashboard
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("title").style.display = "none";
    document.getElementById("dashboard").style.display = "block";

  } catch (err) {
    alert(err.message);
  }
};
</script>

</body>
</html>

